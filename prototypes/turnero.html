<!DOCTYPE html>
<html lang="es" class=""> <!-- La clase 'dark' se añadirá aquí con JS -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RUNIK | Gestor de Tareas y Agenda</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <!-- AOS (Animate On Scroll) Library -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <!-- Configuración de Tailwind para habilitar dark mode por clase -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'brand-gold': '#D4AF37',
                        'dark-bg': '#121212',
                        'light-bg': '#F9F9F9',
                        'dark-card': '#1a1a1a',
                    }
                }
            }
        }
    </script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@200;300;400;500;600&family=Major+Mono+Display&display=swap" rel="stylesheet">
    <!-- Script para evitar el "flash" del tema incorrecto al cargar -->
    <script>
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <style>
        body {
            font-family: 'Jost', sans-serif;
            scroll-behavior: smooth;
        }
        .brand-heading {
            letter-spacing: 0.15em;
        }
        .logo-font {
            font-family: 'Major Mono Display', monospace;
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .task-card {
            cursor: grab;
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
            z-index: 10;
        }
        .task-card.dragging {
            opacity: 0.5;
            transform: scale(0.95);
            z-index: 20;
        }
        .professional-lane.drag-over {
            background-color: rgba(212, 175, 55, 0.1);
        }
        .delete-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .task-card:hover .delete-btn, .professional-item:hover .delete-btn {
            opacity: 1;
        }
        .task-ghost {
            pointer-events: none;
            position: absolute;
            width: calc(100% - 8px);
            left: 4px;
            background-color: rgba(212, 175, 55, 0.2);
            border: 1px dashed #D4AF37;
            border-radius: 0.375rem; /* rounded-md */
            z-index: 5;
        }
        #notification {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-light-bg text-gray-800 dark:bg-dark-bg dark:text-gray-200 antialiased transition-colors duration-500">

    <!-- Notificación -->
    <div id="notification" class="fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg z-50 transform translate-x-[120%] opacity-0">
        <p id="notification-message"></p>
    </div>

    <!-- Encabezado -->
    <header class="bg-dark-bg/80 dark:bg-dark-bg/80 backdrop-blur-sm text-white sticky top-0 z-40 shadow-lg">
        <div class="container mx-auto flex justify-between items-center p-5 px-6">
            <a href="index.html" class="text-4xl tracking-widest logo-font">Runik</a>
            <div class="flex items-center space-x-6 md:space-x-10">
                <button id="theme-toggle" type="button" class="text-gray-400 hover:text-white focus:outline-none p-2 rounded-lg">
                    <span class="sr-only">Toggle dark mode</span>
                    <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 10.607a1 1 0 011.414 0l.707-.707a1 1 0 111.414 1.414l-.707.707a1 1 0 01-1.414 0zM2 11a1 1 0 100-2H1a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 sm:px-6 py-12">
        <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
            
            <aside class="xl:col-span-1 space-y-8" data-aos="fade-right">
                <div class="bg-white dark:bg-dark-card p-6 rounded-lg border border-gray-200 dark:border-gray-800 shadow-sm">
                    <h3 class="text-lg font-semibold brand-heading uppercase mb-4">Profesionales</h3>
                    <div id="professionals-list" class="space-y-2 mb-4"></div>
                    <form id="add-professional-form" class="flex gap-2">
                        <input type="text" id="professional-name" placeholder="Nuevo profesional..." class="flex-grow bg-gray-100 dark:bg-gray-800 border-gray-300 dark:border-gray-700 rounded-md p-2 focus:ring-2 focus:ring-brand-gold outline-none transition text-sm">
                        <button type="submit" class="bg-brand-gold text-dark-bg font-bold p-2 rounded-md hover:bg-yellow-500 transition text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        </button>
                    </form>
                </div>

                <div class="bg-white dark:bg-dark-card p-6 rounded-lg border border-gray-200 dark:border-gray-800 shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold brand-heading uppercase">Tareas Pendientes</h3>
                        <button id="add-task-btn" class="bg-brand-gold text-dark-bg font-bold py-2 px-4 rounded-md hover:bg-yellow-500 transition uppercase text-xs tracking-wider">Crear Tarea</button>
                    </div>
                    <div id="unassigned-tasks" class="min-h-[150px] space-y-3 bg-gray-100 dark:bg-dark-bg p-3 rounded-md"></div>
                </div>
            </aside>

            <div class="xl:col-span-3 bg-white dark:bg-dark-card p-4 sm:p-6 rounded-lg border border-gray-200 dark:border-gray-800 shadow-sm" data-aos="fade-up">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-light brand-heading uppercase">Agenda</h2>
                    <div class="flex items-center gap-2 sm:gap-4">
                        <button id="prev-day-btn" class="p-2 rounded-md bg-white dark:bg-dark-bg border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        </button>
                        <h3 id="current-date" class="text-lg sm:text-xl font-semibold tracking-wider text-center w-64"></h3>
                        <button id="next-day-btn" class="p-2 rounded-md bg-white dark:bg-dark-bg border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>
                <div id="timeline-wrapper" class="overflow-x-auto">
                    <div id="timeline-container" class="relative"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal para Añadir Nueva Tarea -->
    <div id="task-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-light-bg dark:bg-dark-card border border-gray-200 dark:border-gray-700 rounded-lg shadow-xl w-full max-w-md p-8 transform scale-95">
            <h3 class="text-2xl font-light brand-heading mb-6">Nueva Tarea</h3>
            <form id="task-form">
                <div class="mb-4">
                    <label for="task-title" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Descripción</label>
                    <input type="text" id="task-title" required class="w-full bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-brand-gold outline-none transition">
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="task-professional" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Profesional</label>
                        <select id="task-professional" required class="w-full bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-brand-gold outline-none transition"></select>
                    </div>
                    <div>
                        <label for="task-duration" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Duración</label>
                        <select id="task-duration" required class="w-full bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-brand-gold outline-none transition">
                            <option value="10">10 min</option>
                            <option value="20">20 min</option>
                            <option value="30">30 min</option>
                            <option value="45">45 min</option>
                            <option value="60">60 min</option>
                        </select>
                    </div>
                </div>
                <div class="mb-6">
                    <label for="task-time" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Hora de Inicio (Opcional)</label>
                    <input type="time" id="task-time" class="w-full bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-brand-gold outline-none transition">
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-task-btn" class="bg-gray-200 text-black dark:bg-gray-700 dark:text-white font-medium py-2 px-6 rounded-sm hover:opacity-80 transition duration-300 uppercase text-sm tracking-wider">Cancelar</button>
                    <button type="submit" class="bg-brand-gold text-dark-bg font-bold py-2 px-6 rounded-sm hover:bg-yellow-500 transition duration-300 uppercase text-sm tracking-wider">Crear</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Lógica del Dark Mode y AOS init
            const themeToggleBtn = document.getElementById('theme-toggle');
            const darkIcon = document.getElementById('theme-toggle-dark-icon');
            const lightIcon = document.getElementById('theme-toggle-light-icon');
            const htmlEl = document.documentElement;
            function updateIcons() { if (htmlEl.classList.contains('dark')) { darkIcon.classList.add('hidden'); lightIcon.classList.remove('hidden'); } else { darkIcon.classList.remove('hidden'); lightIcon.classList.add('hidden'); } }
            updateIcons();
            themeToggleBtn.addEventListener('click', () => { htmlEl.classList.toggle('dark'); localStorage.setItem('theme', htmlEl.classList.contains('dark') ? 'dark' : 'light'); updateIcons(); });
            AOS.init({ duration: 600, once: true, offset: 20 });

            // --- LÓGICA DEL GESTOR DE TAREAS ---
            let professionals = [ { id: 1, name: 'Dr. Elara Vance', color: 'bg-blue-200', textColor: 'text-blue-800', borderColor: 'border-blue-400' }, { id: 2, name: 'Kaelen Corr', color: 'bg-green-200', textColor: 'text-green-800', borderColor: 'border-green-400' } ];
            let tasks = [ { id: `task-1`, title: 'Consulta Inicial', professionalId: 1, duration: 30, startTime: 540, date: new Date().toISOString().split('T')[0] } ];
            let currentDate = new Date();
            let draggedTaskId = null;
            
            const taskModal = document.getElementById('task-modal');
            const addTaskBtn = document.getElementById('add-task-btn');
            const cancelTaskBtn = document.getElementById('cancel-task-btn');
            const taskForm = document.getElementById('task-form');
            const unassignedContainer = document.getElementById('unassigned-tasks');
            const timelineContainer = document.getElementById('timeline-container');
            const currentDateEl = document.getElementById('current-date');
            const prevDayBtn = document.getElementById('prev-day-btn');
            const nextDayBtn = document.getElementById('next-day-btn');
            const professionalForm = document.getElementById('add-professional-form');
            const professionalsListEl = document.getElementById('professionals-list');
            const professionalSelect = document.getElementById('task-professional');
            const notificationEl = document.getElementById('notification');
            const notificationMessageEl = document.getElementById('notification-message');
            
            const PIXELS_PER_MINUTE = 3;
            const START_HOUR = 8;
            const END_HOUR = 21;

            // --- MANEJO DE NOTIFICACIONES ---
            function showNotification(message) {
                notificationMessageEl.textContent = message;
                notificationEl.classList.remove('transform', 'translate-x-[120%]', 'opacity-0');
                setTimeout(() => {
                    notificationEl.classList.add('transform', 'translate-x-[120%]', 'opacity-0');
                }, 3000);
            }

            // --- MANEJO DE PROFESIONALES ---
            function renderProfessionals() {
                professionalsListEl.innerHTML = '';
                professionalSelect.innerHTML = '<option value="" disabled selected>Seleccione...</option>';
                if (professionals.length === 0) { professionalsListEl.innerHTML = `<p class="text-sm text-gray-500 dark:text-gray-400">Añada un profesional.</p>`; }
                professionals.forEach(prof => {
                    const profEl = document.createElement('div');
                    profEl.className = 'professional-item flex justify-between items-center bg-gray-100 dark:bg-gray-800 p-2 rounded-md';
                    profEl.innerHTML = `<span class="text-sm font-medium">${prof.name}</span><button class="delete-btn text-red-500 hover:text-red-700" data-id="${prof.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>`;
                    profEl.querySelector('.delete-btn').addEventListener('click', () => deleteProfessional(prof.id));
                    professionalsListEl.appendChild(profEl);
                    const optionEl = document.createElement('option');
                    optionEl.value = prof.id; optionEl.textContent = prof.name;
                    professionalSelect.appendChild(optionEl);
                });
            }
            professionalForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const input = document.getElementById('professional-name');
                const name = input.value.trim();
                if (name && !professionals.some(p => p.name === name)) {
                    const colors = [ { color: 'bg-purple-200', textColor: 'text-purple-800', borderColor: 'border-purple-400' }, { color: 'bg-yellow-200', textColor: 'text-yellow-800', borderColor: 'border-yellow-400' }, { color: 'bg-pink-200', textColor: 'text-pink-800', borderColor: 'border-pink-400' }, { color: 'bg-indigo-200', textColor: 'text-indigo-800', borderColor: 'border-indigo-400' } ];
                    professionals.push({ id: Date.now(), name, ...colors[professionals.length % colors.length] });
                    input.value = '';
                    renderAll();
                }
            });
            function deleteProfessional(id) {
                professionals = professionals.filter(p => p.id !== id);
                tasks = tasks.map(t => { if (t.professionalId === id) { t.professionalId = null; t.startTime = null; t.date = null; } return t; });
                renderAll();
            }

            // --- MANEJO DE TAREAS Y MODAL ---
            const openModal = () => { taskModal.classList.remove('hidden'); setTimeout(() => { taskModal.classList.remove('opacity-0'); taskModal.querySelector('.modal-content').classList.remove('scale-95'); }, 10); };
            const closeModal = () => { taskModal.classList.add('opacity-0'); taskModal.querySelector('.modal-content').classList.add('scale-95'); setTimeout(() => { taskModal.classList.add('hidden'); taskForm.reset(); }, 300); };
            addTaskBtn.addEventListener('click', openModal);
            cancelTaskBtn.addEventListener('click', closeModal);
            taskModal.addEventListener('click', (e) => e.target === taskModal && closeModal());

            taskForm.addEventListener('submit', e => {
                e.preventDefault();
                const title = document.getElementById('task-title').value;
                const professionalId = parseInt(document.getElementById('task-professional').value);
                const duration = parseInt(document.getElementById('task-duration').value);
                const time = document.getElementById('task-time').value;
                const date = currentDate.toISOString().split('T')[0];

                let startTime = null;
                if (time) {
                    const [hours, minutes] = time.split(':').map(Number);
                    startTime = hours * 60 + minutes;
                    // Chequeo de colisión al crear
                    if (checkCollision({ id: 'new', professionalId, duration, startTime, date })) {
                        showNotification('Horario ocupado para este profesional.');
                        return;
                    }
                }
                tasks.push({ id: `task-${Date.now()}`, title, professionalId, duration, startTime, date: startTime ? date : null });
                renderAll();
                closeModal();
            });

            // --- RENDERIZADO ---
            function renderUnassignedTasks() {
                unassignedContainer.innerHTML = '';
                tasks.filter(t => t.startTime === null).forEach(task => unassignedContainer.appendChild(createTaskElement(task)));
            }

            function createTaskElement(task) {
                const prof = professionals.find(p => p.id === task.professionalId);
                const taskEl = document.createElement('div');
                taskEl.id = task.id;
                taskEl.className = `task-card relative p-3 rounded-md border text-left ${prof ? `${prof.color} ${prof.textColor} ${prof.borderColor}` : 'bg-gray-200 text-gray-800 border-gray-400'}`;
                taskEl.draggable = true;

                let timeInfo = `<p class="text-xs mt-1 font-medium">${task.duration} min</p>`;
                if (task.startTime !== null) {
                    const formatTime = (totalMinutes) => `${String(Math.floor(totalMinutes / 60)).padStart(2, '0')}:${String(totalMinutes % 60).padStart(2, '0')}`;
                    timeInfo = `<p class="text-xs mt-1 font-bold">${formatTime(task.startTime)} - ${formatTime(task.startTime + task.duration)}</p>`;
                }
                
                taskEl.innerHTML = `<p class="font-semibold text-sm">${task.title}</p><p class="text-xs mt-1">${prof ? prof.name : 'Sin asignar'}</p>${timeInfo}<button class="delete-btn absolute top-1 right-1 text-red-500 hover:text-red-700" data-id="${task.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>`;
                taskEl.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); deleteTask(task.id); });
                return taskEl;
            }

            function deleteTask(id) { tasks = tasks.filter(t => t.id !== id); renderAll(); }
            function renderDate() { currentDateEl.textContent = currentDate.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); }
            prevDayBtn.addEventListener('click', () => { currentDate.setDate(currentDate.getDate() - 1); renderAll(); });
            nextDayBtn.addEventListener('click', () => { currentDate.setDate(currentDate.getDate() + 1); renderAll(); });

            function renderTimeline() {
                timelineContainer.innerHTML = '';
                if(professionals.length === 0) { timelineContainer.innerHTML = `<p class="text-center text-gray-500">Añada un profesional para ver la agenda.</p>`; return; }

                const timelineGrid = document.createElement('div');
                timelineGrid.className = 'grid';
                timelineGrid.style.gridTemplateColumns = `60px repeat(${professionals.length}, 1fr)`;
                timelineGrid.style.minWidth = `${60 + professionals.length * 180}px`;
                
                timelineGrid.innerHTML += `<div class="sticky top-0 z-20 bg-light-bg dark:bg-dark-card"></div>`;
                professionals.forEach(p => { timelineGrid.innerHTML += `<div class="sticky top-0 z-20 bg-light-bg dark:bg-dark-card p-2 text-center font-semibold border-b border-l border-gray-200 dark:border-gray-700">${p.name}</div>`; });

                const lanesContainer = document.createElement('div');
                lanesContainer.className = 'col-span-full grid';
                lanesContainer.style.gridTemplateColumns = `60px repeat(${professionals.length}, 1fr)`;
                
                const timeColumn = document.createElement('div');
                const hourMarkers = document.createElement('div');
                for (let hour = START_HOUR; hour < END_HOUR; hour++) {
                    const timeCell = document.createElement('div');
                    timeCell.className = 'text-center text-xs text-gray-500 border-r border-gray-200 dark:border-gray-700';
                    timeCell.style.height = `${60 * PIXELS_PER_MINUTE}px`;
                    timeColumn.appendChild(timeCell);
                    const marker = document.createElement('div');
                    marker.className = 'relative -top-2 text-center text-xs text-gray-500';
                    marker.textContent = `${String(hour).padStart(2, '0')}:00`;
                    hourMarkers.appendChild(marker);
                    marker.style.paddingTop = `${60 * PIXELS_PER_MINUTE - 16}px`;
                }
                hourMarkers.firstElementChild.style.paddingTop = '0px';

                lanesContainer.appendChild(hourMarkers);

                professionals.forEach(prof => {
                    const lane = document.createElement('div');
                    lane.className = 'professional-lane relative border-l border-gray-200 dark:border-gray-700';
                    lane.dataset.professionalId = prof.id;
                    lane.style.height = `${(END_HOUR - START_HOUR) * 60 * PIXELS_PER_MINUTE}px`;
                    lanesContainer.appendChild(lane);
                });

                timelineContainer.appendChild(timelineGrid);
                timelineContainer.appendChild(lanesContainer);

                placeScheduledTasks();
                addEventListeners();
            }

            function placeScheduledTasks() {
                const todayStr = currentDate.toISOString().split('T')[0];
                tasks.filter(t => t.date === todayStr).forEach(task => {
                    const profLane = timelineContainer.querySelector(`.professional-lane[data-professional-id='${task.professionalId}']`);
                    if(profLane && task.startTime !== null) {
                        const taskEl = createTaskElement(task);
                        taskEl.style.position = 'absolute';
                        taskEl.style.top = `${(task.startTime - START_HOUR * 60) * PIXELS_PER_MINUTE}px`;
                        taskEl.style.height = `${task.duration * PIXELS_PER_MINUTE}px`;
                        taskEl.style.width = 'calc(100% - 8px)';
                        taskEl.style.left = '4px';
                        profLane.appendChild(taskEl);
                    }
                });
            }

            // --- LÓGICA DE DRAG AND DROP ---
            function createGhostElement(task) {
                const ghost = document.createElement('div');
                ghost.className = 'task-ghost';
                ghost.style.height = `${task.duration * PIXELS_PER_MINUTE}px`;
                return ghost;
            }

            function checkCollision(taskToCheck) {
                const todayStr = taskToCheck.date;
                const otherTasks = tasks.filter(t => t.id !== taskToCheck.id && t.professionalId === taskToCheck.professionalId && t.date === todayStr);
                for(const otherTask of otherTasks) {
                    if(taskToCheck.startTime < otherTask.startTime + otherTask.duration && taskToCheck.startTime + taskToCheck.duration > otherTask.startTime) {
                        return otherTask; // Return the colliding task
                    }
                }
                return false;
            }

            function addEventListeners() {
                document.querySelectorAll('.task-card').forEach(card => {
                    card.addEventListener('dragstart', e => { draggedTaskId = e.target.id; setTimeout(() => e.target.classList.add('dragging'), 0); });
                    card.addEventListener('dragend', e => { e.target.classList.remove('dragging'); draggedTaskId = null; });
                });

                document.querySelectorAll('.professional-lane, #unassigned-tasks').forEach(container => {
                    container.addEventListener('dragover', e => {
                        e.preventDefault();
                        if (!draggedTaskId) return;
                        if (container.id === 'unassigned-tasks') return;
                        
                        container.classList.add('drag-over');
                        const draggedTask = tasks.find(t => t.id === draggedTaskId);
                        if (!draggedTask) return;

                        document.querySelectorAll('.task-ghost').forEach(g => g.remove());
                        const ghost = createGhostElement(draggedTask);
                        container.appendChild(ghost);
                        
                        const rect = container.getBoundingClientRect();
                        const dropY = e.clientY - rect.top;
                        const minuteInLane = Math.round(dropY / PIXELS_PER_MINUTE);
                        const snappedMinute = Math.round(minuteInLane / 5) * 5;
                        ghost.style.top = `${snappedMinute * PIXELS_PER_MINUTE}px`;
                    });
                    container.addEventListener('dragleave', e => {
                        if (!container.contains(e.relatedTarget)) {
                           container.classList.remove('drag-over');
                           container.querySelector('.task-ghost')?.remove();
                        }
                    });
                    container.addEventListener('drop', e => {
                        e.preventDefault();
                        container.classList.remove('drag-over');
                        container.querySelector('.task-ghost')?.remove();
                        if (!draggedTaskId) return;

                        const task = tasks.find(t => t.id === draggedTaskId);
                        if (!task) return;

                        if (container.id === 'unassigned-tasks') {
                            task.startTime = null;
                            task.date = null;
                        } else {
                            const targetProfId = parseInt(container.dataset.professionalId);
                            if (task.professionalId !== targetProfId) {
                                showNotification("No se puede cambiar el profesional arrastrando.");
                                return;
                            }
                            
                            const rect = container.getBoundingClientRect();
                            const dropY = e.clientY - rect.top;
                            const minuteInLane = Math.round(dropY / PIXELS_PER_MINUTE);
                            const snappedMinute = Math.round(minuteInLane / 5) * 5;
                            const newStartTime = (START_HOUR * 60) + snappedMinute;

                            const collision = checkCollision({ ...task, startTime: newStartTime, date: currentDate.toISOString().split('T')[0] });
                            if (collision) {
                                showNotification(`Conflicto de horario con la tarea: "${collision.title}".`);
                                return;
                            }
                            
                            task.startTime = newStartTime;
                            task.date = currentDate.toISOString().split('T')[0];
                        }
                        renderAll();
                    });
                });
            }

            function renderAll() {
                renderDate();
                renderProfessionals();
                renderTimeline();
                renderUnassignedTasks();
            }
            renderAll();
        });
    </script>
</body>
</html>

