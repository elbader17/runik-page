<!DOCTYPE html>
<html lang="es" class=""> <!-- La clase 'dark' se añadirá aquí con JS -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RUNIK | Gestor de Tareas y Agenda</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <!-- AOS (Animate On Scroll) Library -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <!-- Configuración de Tailwind para habilitar dark mode por clase -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'brand-gold': '#D4AF37',
                        'dark-bg': '#121212',
                        'light-bg': '#F9F9F9',
                        'dark-card': '#1a1a1a',
                    }
                }
            }
        }
    </script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@200;300;400;500;600&family=Major+Mono+Display&display=swap" rel="stylesheet">
    <!-- Script para evitar el "flash" del tema incorrecto al cargar -->
    <script>
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <style>
        body {
            font-family: 'Jost', sans-serif;
            scroll-behavior: smooth;
        }
        .brand-heading {
            letter-spacing: 0.15em;
        }
        .logo-font {
            font-family: 'Major Mono Display', monospace;
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .task-card {
            cursor: grab;
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
            z-index: 10;
        }
        .task-card.dragging {
            opacity: 0.5;
            transform: scale(0.95);
            z-index: 20;
        }
        .professional-lane.drag-over {
            background-color: rgba(212, 175, 55, 0.1);
        }
        .delete-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .task-card:hover .delete-btn, .professional-item:hover .delete-btn {
            opacity: 1;
        }
        .task-ghost {
            pointer-events: none;
            position: absolute;
            width: calc(100% - 8px);
            left: 4px;
            background-color: rgba(212, 175, 55, 0.2);
            border: 1px dashed #D4AF37;
            border-radius: 0.375rem; /* rounded-md */
            z-index: 5;
        }
        #notification {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }
        /* Layout Fijo */
        html, body {
            height: 100%;
            overflow: hidden;
        }
        .main-layout {
            height: calc(100vh - 84px); /* Altura total menos el header */
        }
        .scrollable-content {
            overflow-y: auto;
        }
        .active-view-btn {
            background-color: #D4AF37 !important;
            color: #121212 !important;
            font-weight: bold;
        }
        /* Estilos para vista de Mes */
        .month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #e5e7eb; /* dark:bg-gray-700 */
        }
        .dark .month-grid {
            background-color: #374151;
        }
        .month-day {
            min-height: 120px;
            position: relative;
        }
        .month-day.other-month {
            background-color: #f3f4f6; /* dark:bg-gray-800 */
        }
        .dark .month-day.other-month {
            background-color: #1f2937;
        }
        .month-task {
            font-size: 0.75rem;
            padding: 2px 4px;
            border-radius: 4px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body class="bg-light-bg text-gray-800 dark:bg-dark-bg dark:text-gray-200 antialiased transition-colors duration-500">

    <!-- Notificación -->
    <div id="notification" class="fixed top-5 right-5 bg-red-500 text-white py-2 px-4 rounded-lg shadow-lg z-50 transform translate-x-[120%] opacity-0">
        <p id="notification-message"></p>
    </div>

    <!-- Encabezado -->
    <header class="bg-dark-bg/80 dark:bg-dark-bg/80 backdrop-blur-sm text-white sticky top-0 z-40 shadow-lg">
        <div class="container mx-auto flex justify-between items-center p-5 px-6">
            <a href="#" class="text-4xl tracking-widest logo-font">Runik</a>
            <div class="flex items-center space-x-6 md:space-x-10">
                <button id="theme-toggle" type="button" class="text-gray-400 hover:text-white focus:outline-none p-2 rounded-lg">
                    <span class="sr-only">Toggle dark mode</span>
                    <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 10.607a1 1 0 011.414 0l.707-.707a1 1 0 111.414 1.414l-.707.707a1 1 0 01-1.414 0zM2 11a1 1 0 100-2H1a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                </button>
            </div>
        </div>
    </header>

    <div class="main-layout flex container mx-auto">
        <!-- Barra Lateral Fija -->
        <aside class="w-full max-w-xs flex-shrink-0 scrollable-content py-8 pr-6 space-y-8" data-aos="fade-right">
            <div class="bg-white dark:bg-dark-card p-6 rounded-lg border border-gray-200 dark:border-gray-800 shadow-sm">
                <h3 class="text-lg font-semibold brand-heading uppercase mb-4">Filtro Profesionales</h3>
                <div id="professional-filter" class="space-y-2 mb-4"></div>
            </div>

            <div class="bg-white dark:bg-dark-card p-6 rounded-lg border border-gray-200 dark:border-gray-800 shadow-sm">
                <h3 class="text-lg font-semibold brand-heading uppercase mb-4">Profesionales</h3>
                <div id="professionals-list" class="space-y-2 mb-4"></div>
                <form id="add-professional-form" class="flex gap-2">
                    <input type="text" id="professional-name" placeholder="Nuevo profesional..." class="flex-grow bg-gray-100 dark:bg-gray-800 border-gray-300 dark:border-gray-700 rounded-md p-2 focus:ring-2 focus:ring-brand-gold outline-none transition text-sm">
                    <button type="submit" class="bg-brand-gold text-dark-bg font-bold p-2 rounded-md hover:bg-yellow-500 transition text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    </button>
                </form>
            </div>

            <div class="bg-white dark:bg-dark-card p-6 rounded-lg border border-gray-200 dark:border-gray-800 shadow-sm">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold brand-heading uppercase">Tareas Pendientes</h3>
                    <button id="add-task-btn" class="bg-brand-gold text-dark-bg font-bold py-2 px-4 rounded-md hover:bg-yellow-500 transition uppercase text-xs tracking-wider">Crear Tarea</button>
                </div>
                <div id="unassigned-tasks" class="min-h-[150px] space-y-3 bg-gray-100 dark:bg-dark-bg p-3 rounded-md"></div>
            </div>
        </aside>

        <!-- Contenido Principal con Scroll -->
        <main class="flex-grow scrollable-content py-8 pl-2">
            <div class="bg-white dark:bg-dark-card p-4 sm:p-6 rounded-lg border border-gray-200 dark:border-gray-800 shadow-sm h-full flex flex-col" data-aos="fade-up">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4 flex-shrink-0">
                    <div class="flex items-center gap-2">
                        <button id="view-day-btn" class="view-btn px-4 py-2 rounded-md text-sm border border-gray-300 dark:border-gray-600 transition">Día</button>
                        <button id="view-week-btn" class="view-btn px-4 py-2 rounded-md text-sm border border-gray-300 dark:border-gray-600 transition">Semana</button>
                        <button id="view-month-btn" class="view-btn px-4 py-2 rounded-md text-sm border border-gray-300 dark:border-gray-600 transition">Mes</button>
                    </div>
                    <div class="flex items-center gap-2 sm:gap-4">
                        <button id="prev-btn" class="p-2 rounded-md bg-white dark:bg-dark-bg border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        </button>
                        <h3 id="current-date" class="text-lg sm:text-xl font-semibold tracking-wider text-center w-64"></h3>
                        <button id="next-btn" class="p-2 rounded-md bg-white dark:bg-dark-bg border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>
                <div id="timeline-wrapper" class="overflow-auto flex-grow">
                    <div id="timeline-container" class="relative"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal para Añadir Nueva Tarea -->
    <div id="task-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-light-bg dark:bg-dark-card border border-gray-200 dark:border-gray-700 rounded-lg shadow-xl w-full max-w-md p-8 transform scale-95">
            <h3 class="text-2xl font-light brand-heading mb-6">Nueva Tarea</h3>
            <form id="task-form">
                <div class="mb-4">
                    <label for="task-title" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Descripción</label>
                    <input type="text" id="task-title" required class="w-full bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-brand-gold outline-none transition">
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="task-professional" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Profesional</label>
                        <select id="task-professional" required class="w-full bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-brand-gold outline-none transition"></select>
                    </div>
                    <div>
                        <label for="task-duration" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Duración</label>
                        <select id="task-duration" required class="w-full bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-brand-gold outline-none transition">
                            <option value="10">10 min</option>
                            <option value="20">20 min</option>
                            <option value="30">30 min</option>
                            <option value="45">45 min</option>
                            <option value="60">60 min</option>
                        </select>
                    </div>
                </div>
                <div class="mb-6">
                    <label for="task-time" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Hora de Inicio (Opcional)</label>
                    <input type="time" id="task-time" class="w-full bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-brand-gold outline-none transition">
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-task-btn" class="bg-gray-200 text-black dark:bg-gray-700 dark:text-white font-medium py-2 px-6 rounded-sm hover:opacity-80 transition duration-300 uppercase text-sm tracking-wider">Cancelar</button>
                    <button type="submit" class="bg-brand-gold text-dark-bg font-bold py-2 px-6 rounded-sm hover:bg-yellow-500 transition duration-300 uppercase text-sm tracking-wider">Crear</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Lógica del Dark Mode y AOS init ---
            // ... (código existente sin cambios)
            const themeToggleBtn = document.getElementById('theme-toggle');
            const darkIcon = document.getElementById('theme-toggle-dark-icon');
            const lightIcon = document.getElementById('theme-toggle-light-icon');
            const htmlEl = document.documentElement;
            function updateIcons() { if (htmlEl.classList.contains('dark')) { darkIcon.classList.add('hidden'); lightIcon.classList.remove('hidden'); } else { darkIcon.classList.remove('hidden'); lightIcon.classList.add('hidden'); } }
            updateIcons();
            themeToggleBtn.addEventListener('click', () => { htmlEl.classList.toggle('dark'); localStorage.setItem('theme', htmlEl.classList.contains('dark') ? 'dark' : 'light'); updateIcons(); });
            AOS.init({ duration: 600, once: true, offset: 20 });


            // --- LÓGICA DEL GESTOR DE TAREAS ---
            let professionals = [ { id: 1, name: 'Dr. Elara Vance', color: 'bg-blue-200', textColor: 'text-blue-800', borderColor: 'border-blue-400', visible: true }, { id: 2, name: 'Kaelen Corr', color: 'bg-green-200', textColor: 'text-green-800', borderColor: 'border-green-400', visible: true } ];
            let tasks = [ { id: `task-1`, title: 'Consulta Inicial', professionalId: 1, duration: 30, startTime: 540, date: new Date().toISOString().split('T')[0] } ];
            let currentDate = new Date();
            let currentView = 'day'; // 'day', 'week', 'month'
            let draggedTaskId = null;
            
            // --- DOM Elements ---
            const taskModal = document.getElementById('task-modal');
            const addTaskBtn = document.getElementById('add-task-btn');
            const cancelTaskBtn = document.getElementById('cancel-task-btn');
            const taskForm = document.getElementById('task-form');
            const unassignedContainer = document.getElementById('unassigned-tasks');
            const timelineContainer = document.getElementById('timeline-container');
            const currentDateEl = document.getElementById('current-date');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const professionalForm = document.getElementById('add-professional-form');
            const professionalsListEl = document.getElementById('professionals-list');
            const professionalSelect = document.getElementById('task-professional');
            const notificationEl = document.getElementById('notification');
            const notificationMessageEl = document.getElementById('notification-message');
            const professionalFilterEl = document.getElementById('professional-filter');
            const viewDayBtn = document.getElementById('view-day-btn');
            const viewWeekBtn = document.getElementById('view-week-btn');
            const viewMonthBtn = document.getElementById('view-month-btn');

            const PIXELS_PER_MINUTE = 3;
            const START_HOUR = 8;
            const END_HOUR = 21;
            const MAX_VISIBLE_PROFESSIONALS = 5;

            // --- MANEJO DE NOTIFICACIONES ---
            function showNotification(message, isError = true) {
                notificationMessageEl.textContent = message;
                notificationEl.classList.toggle('bg-red-500', isError);
                notificationEl.classList.toggle('bg-green-500', !isError);
                notificationEl.classList.remove('transform', 'translate-x-[120%]', 'opacity-0');
                setTimeout(() => {
                    notificationEl.classList.add('transform', 'translate-x-[120%]', 'opacity-0');
                }, 3000);
            }

            // --- MANEJO DE PROFESIONALES Y FILTROS ---
            function renderProfessionals() {
                // ... (código existente, sin cambios)
                 professionalsListEl.innerHTML = '';
                professionalSelect.innerHTML = '<option value="" disabled selected>Seleccione...</option>';
                if (professionals.length === 0) { professionalsListEl.innerHTML = `<p class="text-sm text-gray-500 dark:text-gray-400">Añada un profesional.</p>`; }
                professionals.forEach(prof => {
                    const profEl = document.createElement('div');
                    profEl.className = 'professional-item flex justify-between items-center bg-gray-100 dark:bg-gray-800 p-2 rounded-md';
                    profEl.innerHTML = `<span class="text-sm font-medium">${prof.name}</span><button class="delete-btn text-red-500 hover:text-red-700" data-id="${prof.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>`;
                    profEl.querySelector('.delete-btn').addEventListener('click', () => deleteProfessional(prof.id));
                    professionalsListEl.appendChild(profEl);
                    const optionEl = document.createElement('option');
                    optionEl.value = prof.id; optionEl.textContent = prof.name;
                    professionalSelect.appendChild(optionEl);
                });
            }

            function renderProfessionalFilters() {
                professionalFilterEl.innerHTML = '';
                professionals.forEach(prof => {
                    const filterItem = document.createElement('div');
                    filterItem.className = 'flex items-center';
                    filterItem.innerHTML = `
                        <input id="filter-${prof.id}" type="checkbox" ${prof.visible ? 'checked' : ''} class="w-4 h-4 text-brand-gold bg-gray-100 border-gray-300 rounded focus:ring-brand-gold dark:focus:ring-yellow-500 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                        <label for="filter-${prof.id}" class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">${prof.name}</label>
                    `;
                    filterItem.querySelector('input').addEventListener('change', (e) => {
                        const visibleCount = professionals.filter(p => p.visible).length;
                        if (e.target.checked && visibleCount >= MAX_VISIBLE_PROFESSIONALS) {
                            e.target.checked = false;
                            showNotification(`Solo se pueden mostrar ${MAX_VISIBLE_PROFESSIONALS} profesionales a la vez.`);
                            return;
                        }
                        prof.visible = e.target.checked;
                        renderAll();
                    });
                    professionalFilterEl.appendChild(filterItem);
                });
            }

            professionalForm.addEventListener('submit', (e) => {
                 e.preventDefault();
                const input = document.getElementById('professional-name');
                const name = input.value.trim();
                if (name && !professionals.some(p => p.name === name)) {
                    const colors = [ { color: 'bg-purple-200', textColor: 'text-purple-800', borderColor: 'border-purple-400' }, { color: 'bg-yellow-200', textColor: 'text-yellow-800', borderColor: 'border-yellow-400' }, { color: 'bg-pink-200', textColor: 'text-pink-800', borderColor: 'border-pink-400' }, { color: 'bg-indigo-200', textColor: 'text-indigo-800', borderColor: 'border-indigo-400' } ];
                    professionals.push({ id: Date.now(), name, ...colors[professionals.length % colors.length], visible: true });
                    input.value = '';
                    renderAll();
                }
            });
            
            function deleteProfessional(id) {
                professionals = professionals.filter(p => p.id !== id);
                tasks = tasks.map(t => { if (t.professionalId === id) { t.professionalId = null; t.startTime = null; t.date = null; } return t; });
                renderAll();
            }

            // --- MANEJO DE TAREAS Y MODAL ---
            // ... (código existente sin cambios)
            const openModal = () => { taskModal.classList.remove('hidden'); setTimeout(() => { taskModal.classList.remove('opacity-0'); taskModal.querySelector('.modal-content').classList.remove('scale-95'); }, 10); };
            const closeModal = () => { taskModal.classList.add('opacity-0'); taskModal.querySelector('.modal-content').classList.add('scale-95'); setTimeout(() => { taskModal.classList.add('hidden'); taskForm.reset(); }, 300); };
            addTaskBtn.addEventListener('click', openModal);
            cancelTaskBtn.addEventListener('click', closeModal);
            taskModal.addEventListener('click', (e) => e.target === taskModal && closeModal());

             taskForm.addEventListener('submit', e => {
                e.preventDefault();
                const title = document.getElementById('task-title').value;
                const professionalId = parseInt(document.getElementById('task-professional').value);
                const duration = parseInt(document.getElementById('task-duration').value);
                const time = document.getElementById('task-time').value;
                const date = currentDate.toISOString().split('T')[0];

                let startTime = null;
                if (time) {
                    const [hours, minutes] = time.split(':').map(Number);
                    startTime = hours * 60 + minutes;
                    // Chequeo de colisión al crear
                    if (checkCollision({ id: 'new', professionalId, duration, startTime, date })) {
                        showNotification('Horario ocupado para este profesional.');
                        return;
                    }
                }
                tasks.push({ id: `task-${Date.now()}`, title, professionalId, duration, startTime, date: startTime ? date : null });
                renderAll();
                closeModal();
            });

            // --- LÓGICA DE NAVEGACIÓN Y VISTAS ---
            function updateViewButtons() {
                document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active-view-btn'));
                if (currentView === 'day') viewDayBtn.classList.add('active-view-btn');
                else if (currentView === 'week') viewWeekBtn.classList.add('active-view-btn');
                else if (currentView === 'month') viewMonthBtn.classList.add('active-view-btn');
            }

            viewDayBtn.addEventListener('click', () => { currentView = 'day'; renderAll(); });
            viewWeekBtn.addEventListener('click', () => { currentView = 'week'; renderAll(); });
            viewMonthBtn.addEventListener('click', () => { currentView = 'month'; renderAll(); });

            prevBtn.addEventListener('click', () => {
                if (currentView === 'day') currentDate.setDate(currentDate.getDate() - 1);
                else if (currentView === 'week') currentDate.setDate(currentDate.getDate() - 7);
                else if (currentView === 'month') currentDate.setMonth(currentDate.getMonth() - 1);
                renderAll();
            });

            nextBtn.addEventListener('click', () => {
                if (currentView === 'day') currentDate.setDate(currentDate.getDate() + 1);
                else if (currentView === 'week') currentDate.setDate(currentDate.getDate() + 7);
                else if (currentView === 'month') currentDate.setMonth(currentDate.getMonth() + 1);
                renderAll();
            });

            // --- RENDERIZADO PRINCIPAL ---
            function renderUnassignedTasks() {
                unassignedContainer.innerHTML = '';
                tasks.filter(t => t.startTime === null).forEach(task => unassignedContainer.appendChild(createTaskElement(task, { isDraggable: true })));
            }

            function createTaskElement(task, options = {}) {
                const { isDraggable = false } = options;
                const prof = professionals.find(p => p.id === task.professionalId);
                const taskEl = document.createElement('div');
                taskEl.id = task.id;
                taskEl.className = `task-card relative p-3 rounded-md border text-left ${prof ? `${prof.color} ${prof.textColor} ${prof.borderColor}` : 'bg-gray-200 text-gray-800 border-gray-400'}`;
                taskEl.draggable = isDraggable;

                let timeInfo = `<p class="text-xs mt-1 font-medium">${task.duration} min</p>`;
                if (task.startTime !== null) {
                    const formatTime = (totalMinutes) => `${String(Math.floor(totalMinutes / 60)).padStart(2, '0')}:${String(totalMinutes % 60).padStart(2, '0')}`;
                    timeInfo = `<p class="text-xs mt-1 font-bold">${formatTime(task.startTime)} - ${formatTime(task.startTime + task.duration)}</p>`;
                }
                
                taskEl.innerHTML = `<p class="font-semibold text-sm">${task.title}</p><p class="text-xs mt-1">${prof ? prof.name : 'Sin asignar'}</p>${timeInfo}<button class="delete-btn absolute top-1 right-1 text-red-500 hover:text-red-700" data-id="${task.id}"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>`;
                taskEl.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); deleteTask(task.id); });
                return taskEl;
            }

            function deleteTask(id) { tasks = tasks.filter(t => t.id !== id); renderAll(); }

            function renderDate() {
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                if (currentView === 'day') {
                    currentDateEl.textContent = currentDate.toLocaleDateString('es-ES', { weekday: 'long', ...options });
                } else if (currentView === 'week') {
                    const startOfWeek = new Date(currentDate);
                    startOfWeek.setDate(currentDate.getDate() - currentDate.getDay() + (currentDate.getDay() === 0 ? -6 : 1));
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    currentDateEl.textContent = `${startOfWeek.toLocaleDateString('es-ES', {day:'numeric', month:'long'})} - ${endOfWeek.toLocaleDateString('es-ES', {day:'numeric', month:'long', year:'numeric'})}`;
                } else if (currentView === 'month') {
                    currentDateEl.textContent = currentDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                }
            }
            
            // --- RENDERIZADO DE VISTAS ---
            function renderDayView() {
                const visibleProfessionals = professionals.filter(p => p.visible);
                timelineContainer.innerHTML = '';
                if(visibleProfessionals.length === 0) { timelineContainer.innerHTML = `<p class="text-center text-gray-500">Seleccione un profesional para ver la agenda.</p>`; return; }

                const timelineGrid = document.createElement('div');
                timelineGrid.className = 'grid';
                timelineGrid.style.gridTemplateColumns = `60px repeat(${visibleProfessionals.length}, 1fr)`;
                timelineGrid.style.minWidth = `${60 + visibleProfessionals.length * 180}px`;
                
                timelineGrid.innerHTML += `<div class="sticky top-0 z-20 bg-light-bg dark:bg-dark-card"></div>`;
                visibleProfessionals.forEach(p => { timelineGrid.innerHTML += `<div class="sticky top-0 z-20 bg-light-bg dark:bg-dark-card p-2 text-center font-semibold border-b border-l border-gray-200 dark:border-gray-700">${p.name}</div>`; });

                const lanesContainer = document.createElement('div');
                lanesContainer.className = 'col-span-full grid';
                lanesContainer.style.gridTemplateColumns = `60px repeat(${visibleProfessionals.length}, 1fr)`;
                
                const timeColumn = document.createElement('div');
                const hourMarkers = document.createElement('div');
                for (let hour = START_HOUR; hour < END_HOUR; hour++) {
                    const marker = document.createElement('div');
                    marker.className = 'relative text-center text-xs text-gray-500 border-t border-gray-200 dark:border-gray-700';
                    marker.innerHTML = `<span class="absolute -top-2 left-1/2 -translate-x-1/2 bg-light-bg dark:bg-dark-card px-1">${String(hour).padStart(2, '0')}:00</span>`;
                    marker.style.height = `${60 * PIXELS_PER_MINUTE}px`;
                    hourMarkers.appendChild(marker);
                }
                lanesContainer.appendChild(hourMarkers);

                visibleProfessionals.forEach(prof => {
                    const lane = document.createElement('div');
                    lane.className = 'professional-lane relative border-l border-gray-200 dark:border-gray-700';
                    lane.dataset.professionalId = prof.id;
                    lane.style.height = `${(END_HOUR - START_HOUR) * 60 * PIXELS_PER_MINUTE}px`;
                    // Add hour lines for each lane
                    for (let hour = START_HOUR; hour < END_HOUR; hour++) {
                        const line = document.createElement('div');
                        line.className = 'border-t border-gray-200 dark:border-gray-700';
                        line.style.height = `${60 * PIXELS_PER_MINUTE}px`;
                        lane.appendChild(line);
                    }
                    lanesContainer.appendChild(lane);
                });

                timelineContainer.appendChild(timelineGrid);
                timelineContainer.appendChild(lanesContainer);

                placeScheduledTasks(visibleProfessionals);
                addDragDropEventListeners();
            }

            function renderWeekView() {
                timelineContainer.innerHTML = 'Vista de Semana (funcionalidad en desarrollo)';
                // Placeholder - detailed implementation is complex
            }

            function renderMonthView() {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startOfWeek = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; // 0=Lunes

                timelineContainer.innerHTML = '';
                const grid = document.createElement('div');
                grid.className = 'month-grid';
                
                // Day headers
                const days = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
                days.forEach(day => {
                    grid.innerHTML += `<div class="p-2 text-center font-bold text-sm bg-white dark:bg-dark-card">${day}</div>`;
                });

                // Previous month's days
                for (let i = 0; i < startOfWeek; i++) {
                    grid.innerHTML += `<div class="month-day other-month"></div>`;
                }

                // Current month's days
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayCell = document.createElement('div');
                    const thisDate = new Date(year, month, day);
                    const dateStr = thisDate.toISOString().split('T')[0];
                    dayCell.className = 'month-day p-2 bg-white dark:bg-dark-card';
                    dayCell.innerHTML = `<span class="font-bold text-sm">${day}</span>`;
                    
                    const dayTasks = tasks.filter(t => t.date === dateStr && professionals.find(p => p.id === t.professionalId && p.visible));
                    dayTasks.sort((a,b) => a.startTime - b.startTime).forEach(task => {
                        const prof = professionals.find(p => p.id === task.professionalId);
                        const taskEl = document.createElement('div');
                        taskEl.className = `month-task ${prof.color} ${prof.textColor}`;
                        taskEl.textContent = task.title;
                        dayCell.appendChild(taskEl);
                    });

                    grid.appendChild(dayCell);
                }
                timelineContainer.appendChild(grid);
            }
            
            function placeScheduledTasks(visibleProfessionals) {
                const todayStr = currentDate.toISOString().split('T')[0];
                tasks.filter(t => t.date === todayStr && visibleProfessionals.some(p => p.id === t.professionalId)).forEach(task => {
                    const profLane = timelineContainer.querySelector(`.professional-lane[data-professional-id='${task.professionalId}']`);
                    if(profLane && task.startTime !== null) {
                        const taskEl = createTaskElement(task, { isDraggable: true });
                        taskEl.style.position = 'absolute';
                        taskEl.style.top = `${(task.startTime - START_HOUR * 60) * PIXELS_PER_MINUTE}px`;
                        taskEl.style.height = `${task.duration * PIXELS_PER_MINUTE}px`;
                        taskEl.style.width = 'calc(100% - 8px)';
                        taskEl.style.left = '4px';
                        profLane.appendChild(taskEl);
                    }
                });
            }

            // --- LÓGICA DE DRAG AND DROP ---
            function checkCollision(taskToCheck) {
                // ... (código existente sin cambios)
                const todayStr = taskToCheck.date;
                const otherTasks = tasks.filter(t => t.id !== taskToCheck.id && t.professionalId === taskToCheck.professionalId && t.date === todayStr);
                for(const otherTask of otherTasks) {
                    if(taskToCheck.startTime < otherTask.startTime + otherTask.duration && taskToCheck.startTime + taskToCheck.duration > otherTask.startTime) {
                        return otherTask; // Return the colliding task
                    }
                }
                return false;
            }

            function addDragDropEventListeners() {
                // ... (lógica existente movida aquí)
                document.querySelectorAll('.task-card').forEach(card => {
                    card.addEventListener('dragstart', e => { draggedTaskId = e.target.id; setTimeout(() => e.target.classList.add('dragging'), 0); });
                    card.addEventListener('dragend', e => { e.target.classList.remove('dragging'); draggedTaskId = null; });
                });

                document.querySelectorAll('.professional-lane, #unassigned-tasks').forEach(container => {
                    container.addEventListener('dragover', e => {
                        e.preventDefault();
                        if (!draggedTaskId || container.id === 'unassigned-tasks') return;
                        
                        container.classList.add('drag-over');
                        const draggedTask = tasks.find(t => t.id === draggedTaskId);
                        if (!draggedTask) return;

                        document.querySelectorAll('.task-ghost').forEach(g => g.remove());
                        const ghost = document.createElement('div');
                        ghost.className = 'task-ghost';
                        ghost.style.height = `${draggedTask.duration * PIXELS_PER_MINUTE}px`;
                        container.appendChild(ghost);
                        
                        const rect = container.getBoundingClientRect();
                        const dropY = e.clientY - rect.top;
                        const minuteInLane = Math.round(dropY / PIXELS_PER_MINUTE);
                        const snappedMinute = Math.round(minuteInLane / 5) * 5;
                        ghost.style.top = `${snappedMinute * PIXELS_PER_MINUTE}px`;
                    });
                    container.addEventListener('dragleave', e => {
                        if (!container.contains(e.relatedTarget)) {
                            container.classList.remove('drag-over');
                            container.querySelector('.task-ghost')?.remove();
                        }
                    });
                    container.addEventListener('drop', e => {
                        e.preventDefault();
                        container.classList.remove('drag-over');
                        container.querySelector('.task-ghost')?.remove();
                        if (!draggedTaskId) return;

                        const task = tasks.find(t => t.id === draggedTaskId);
                        if (!task) return;

                        if (container.id === 'unassigned-tasks') {
                            task.startTime = null;
                            task.date = null;
                        } else {
                            const targetProfId = parseInt(container.dataset.professionalId);
                            if (task.professionalId !== targetProfId) {
                                showNotification("No se puede cambiar el profesional arrastrando. Cree una nueva tarea.");
                                return;
                            }
                            
                            const rect = container.getBoundingClientRect();
                            const dropY = e.clientY - rect.top;
                            const minuteInLane = Math.round(dropY / PIXELS_PER_MINUTE);
                            const snappedMinute = Math.round(minuteInLane / 5) * 5;
                            const newStartTime = (START_HOUR * 60) + snappedMinute;

                            const collision = checkCollision({ ...task, startTime: newStartTime, date: currentDate.toISOString().split('T')[0] });
                            if (collision) {
                                showNotification(`Conflicto de horario con la tarea: "${collision.title}".`);
                                return;
                            }
                            
                            task.startTime = newStartTime;
                            task.date = currentDate.toISOString().split('T')[0];
                        }
                        renderAll();
                    });
                });
            }

            function renderAll() {
                updateViewButtons();
                renderDate();
                renderProfessionals();
                renderProfessionalFilters();
                
                if (currentView === 'day') {
                    renderDayView();
                } else if (currentView === 'week') {
                    renderWeekView(); // Aún no implementada
                } else if (currentView === 'month') {
                    renderMonthView();
                }
                
                renderUnassignedTasks();
            }
            renderAll();
        });
    </script>
</body>
</html>
